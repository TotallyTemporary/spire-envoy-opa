# no access log, critical only
log_format  null  '';
access_log  off;
error_log  /var/log/nginx/error.log  crit;

upstream blackhole {
    server 127.0.0.1:9  max_fails=0;   # instafail
}

server {
    listen      4002 reuseport;
    server_name _;

    # receive in memory since raspberry sd card is so slow
    client_max_body_size     2m;
    client_body_buffer_size  2m;
    client_body_in_single_buffer on;

    location / {
        # pretend we want to proxy data so nginx actually receives whole POST body.
        proxy_pass              http://blackhole;
        proxy_request_buffering on;

        # fail fast, but we have workers at all times so not a huge deal to waste a few ms.
        proxy_connect_timeout   5ms;
        proxy_read_timeout      5ms;
        proxy_next_upstream     off;

        # proxy connect will fail (TCP port 9 is discard), turn 502 into a 204. 
        proxy_intercept_errors  on;
        error_page              502 504 =204 @empty;
    }

    # redirect to this endpoint that returns minimal 204
    location @empty {
        internal;
        add_header  Content-Length 0;
        return 204;
    }
}

